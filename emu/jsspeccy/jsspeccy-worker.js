(()=>{"use strict";class e{constructor(e,t){this.pulseLength=e,this.pulseCount=t,this.pulsesGenerated=0}isFinished(){return this.pulsesGenerated==this.pulseCount}getNextPulseLength(){return this.pulsesGenerated++,this.pulseLength}}class t{constructor(e){this.pulses=e,this.index=0}isFinished(){return this.index==this.pulses.length}getNextPulseLength(){return this.pulses[this.index++]}}class s{constructor(e,t,s,n){this.data=e,this.zeroPulseLength=t,this.onePulseLength=s,this.bitCount=8*(this.data.length-1)+n,this.pulsesOutput=0,this.lastPulseLength=null}isFinished(){return this.pulsesOutput==2*this.bitCount}getNextPulseLength(){if(1&this.pulsesOutput)return this.pulsesOutput++,this.lastPulseLength;{const e=this.pulsesOutput>>1,t=e>>3,s=1<<7-(7&e);return this.lastPulseLength=this.data[t]&s?this.onePulseLength:this.zeroPulseLength,this.pulsesOutput++,this.lastPulseLength}}}class n{constructor(e){this.duration=e,this.emitted=!1}isFinished(){return this.emitted}getNextPulseLength(){return this.emitted=!0,3500*this.duration}}class a{constructor(e){this.segments=[],this.getSegments=e,this.level=0,this.tapeIsFinished=!1,this.pendingCycles=0}addSegment(e){this.segments.push(e)}emitPulses(e,t,s){let n=0,a=t,r=!1;for(;n<s;)if(this.pendingCycles>0)this.pendingCycles>=32768?(e[a++]=32767|this.level,n+=32767,this.pendingCycles-=32767):(e[a++]=this.level|this.pendingCycles,n+=this.pendingCycles,this.pendingCycles=0);else if(0===this.segments.length){if(this.tapeIsFinished){r=!0;break}this.tapeIsFinished=!this.getSegments(this)}else this.segments[0].isFinished()?this.segments.shift():(this.pendingCycles=this.segments[0].getNextPulseLength(),this.level^=32768);return[a,n,r]}}class r{constructor(r){let i=0;this.blocks=[];for(var o=new DataView(r);i+1<r.byteLength;){const e=o.getUint16(i,!0);i+=2,this.blocks.push(new Uint8Array(r,i,e)),i+=e}this.nextBlockIndex=0,this.pulseGenerator=new a((a=>{if(0===this.blocks.length)return!1;const r=this.blocks[this.nextBlockIndex];return this.nextBlockIndex=(this.nextBlockIndex+1)%this.blocks.length,128&r[0]?a.addSegment(new e(2168,3223)):a.addSegment(new e(2168,8063)),a.addSegment(new t([667,735])),a.addSegment(new s(r,855,1710,8)),a.addSegment(new n(1e3)),0!=this.nextBlockIndex}))}getNextLoadableBlock(){if(0===this.blocks.length)return null;const e=this.blocks[this.nextBlockIndex];return this.nextBlockIndex=(this.nextBlockIndex+1)%this.blocks.length,e}static isValid(e){let t=0;const s=new DataView(e);for(;t<e.byteLength;){if(t+1>=e.byteLength)return!1;t+=s.getUint16(t,!0)+2}return t==e.byteLength}}class i{static isValid(e){const t=new DataView(e),s="ZXTape!";for(let e=0;e<s.length;e++)if(s.charCodeAt(e)!=t.getUint8(e))return!1;return!0}constructor(r){this.blocks=[];const i=new DataView(r);let o=10;for(;o<r.byteLength;){const a=i.getUint8(o);switch(o++,a){case 16:(()=>{const a=i.getUint16(o,!0);o+=2;const c=i.getUint16(o,!0);o+=2;const l=new Uint8Array(r,o,c);this.blocks.push({type:"StandardSpeedData",pause:a,data:l,generatePulses:r=>{128&l[0]?r.addSegment(new e(2168,3223)):r.addSegment(new e(2168,8063)),r.addSegment(new t([667,735])),r.addSegment(new s(l,855,1710,8)),a&&r.addSegment(new n(a))}}),o+=c})();break;case 17:(()=>{const a=i.getUint16(o,!0);o+=2;const c=i.getUint16(o,!0);o+=2;const l=i.getUint16(o,!0);o+=2;const h=i.getUint16(o,!0);o+=2;const u=i.getUint16(o,!0);o+=2;const d=i.getUint16(o,!0);o+=2;const p=i.getUint8(o);o+=1;const g=i.getUint16(o,!0);o+=2;const k=i.getUint16(o,!0)|i.getUint8(o+2)<<16;o+=3;const f=new Uint8Array(r,o,k);this.blocks.push({type:"TurboSpeedData",pilotPulseLength:a,syncPulse1Length:c,syncPulse2Length:l,zeroBitLength:h,oneBitLength:u,pilotPulseCount:d,lastByteMask:p,pause:g,data:f,generatePulses:r=>{r.addSegment(new e(a,d)),r.addSegment(new t([c,l])),r.addSegment(new s(f,h,u,p)),g&&r.addSegment(new n(g))}}),o+=k})();break;case 18:(()=>{const t=i.getUint16(o,!0);o+=2;const s=i.getUint16(o,!0);o+=2,this.blocks.push({type:"PureTone",pulseLength:t,pulseCount:s,generatePulses:n=>{n.addSegment(new e(t,s))}})})();break;case 19:(()=>{const e=i.getUint8(o);o+=1;const s=[];for(let t=0;t<e;t++)s[t]=i.getUint16(o+2*t,!0);this.blocks.push({type:"PulseSequence",pulseLengths:s,generatePulses:e=>{e.addSegment(new t(s))}}),o+=2*e})();break;case 20:(()=>{const e=i.getUint16(o,!0);o+=2;const t=i.getUint16(o,!0);o+=2;const a=i.getUint8(o);o+=1;const c=i.getUint16(o,!0);o+=2;const l=i.getUint16(o,!0)|i.getUint8(o+2)<<16;o+=3;const h=new Uint8Array(r,o,l);this.blocks.push({type:"PureData",zeroBitLength:e,oneBitLength:t,lastByteMask:a,pause:c,data:h,generatePulses:r=>{r.addSegment(new s(h,e,t,a)),c&&r.addSegment(new n(c))}}),o+=l})();break;case 21:(()=>{const e=i.getUint16(o,!0);o+=2;const t=i.getUint16(o,!0);o+=2;const s=i.getUint8(o);o+=1;const n=i.getUint16(o,!0)|i.getUint8(o+2)<<16;o+=3,this.blocks.push({type:"DirectRecording",tstatesPerSample:e,lastByteMask:s,pause:t,data:new Uint8Array(r,o,n)}),o+=n})();break;case 32:(()=>{const e=i.getUint16(o,!0);o+=2,this.blocks.push({type:"Pause",pause:e,generatePulses:t=>{t.addSegment(new n(e))}})})();break;case 33:(()=>{const e=i.getUint8(o);o+=1;const t=new Uint8Array(r,o,e);o+=e;const s=String.fromCharCode.apply(null,t);this.blocks.push({type:"GroupStart",name:s})})();break;case 34:(()=>{this.blocks.push({type:"GroupEnd"})})();break;case 35:(()=>{const e=i.getUint16(o,!0);o+=2,this.blocks.push({type:"JumpToBlock",offset:e})})();break;case 36:(()=>{const e=i.getUint16(o,!0);o+=2,this.blocks.push({type:"LoopStart",repeatCount:e})})();break;case 37:(()=>{this.blocks.push({type:"LoopEnd"})})();break;case 38:(()=>{const e=i.getUint16(o,!0);o+=2;const t=[];for(let s=0;s<e;s++)t[s]=i.getUint16(o+2*s,!0);this.blocks.push({type:"CallSequence",offsets:t}),o+=2*e})();break;case 39:(()=>{this.blocks.push({type:"ReturnFromSequence"})})();break;case 40:(()=>{const e=i.getUint16(o,!0);o+=2,this.blocks.push({type:"Select",data:new Uint8Array(r,o,e)}),o+=e})();break;case 48:(()=>{const e=i.getUint8(o);o+=1;const t=new Uint8Array(r,o,e);o+=e;const s=String.fromCharCode.apply(null,t);this.blocks.push({type:"TextDescription",text:s})})();break;case 49:(()=>{const e=i.getUint8(o);o+=1;const t=i.getUint8(o);o+=1;const s=new Uint8Array(r,o,t);o+=t;const n=String.fromCharCode.apply(null,s);this.blocks.push({type:"MessageBlock",displayTime:e,text:n})})();break;case 50:(()=>{const e=i.getUint16(o,!0);o+=2,this.blocks.push({type:"ArchiveInfo",data:new Uint8Array(r,o,e)}),o+=e})();break;case 51:(()=>{const e=3*i.getUint8(o);o+=1,this.blocks.push({type:"HardwareType",data:new Uint8Array(r,o,e)}),o+=e})();break;case 53:(()=>{const e=new Uint8Array(r,o,10);o+=10;const t=String.fromCharCode.apply(null,e),s=i.getUint32(o,!0);this.blocks.push({type:"CustomInfo",identifier:t,data:new Uint8Array(r,o,s)}),o+=s})();break;case 90:(()=>{o+=9,this.blocks.push({type:"Glue"})})();break;default:(()=>{const e=i.getUint32(o,!0);o+=4,this.blocks.push({type:"unknown",data:new Uint8Array(r,o,e)}),o+=e})()}}this.nextBlockIndex=0,this.loopToBlockIndex,this.repeatCount,this.callStack=[],this.pulseGenerator=new a((e=>{const t=this.getNextMeaningfulBlock(!1);return!!t&&(t.generatePulses(e),!0)}))}getNextMeaningfulBlock(e){let t=0===this.nextBlockIndex;for(;;){if(this.nextBlockIndex>=this.blocks.length){if(t||!e)return null;this.nextBlockIndex=0,t=!0}var s=this.blocks[this.nextBlockIndex];switch(s.type){case"StandardSpeedData":case"TurboSpeedData":case"PureTone":case"PulseSequence":case"PureData":case"DirectRecording":case"Pause":return this.nextBlockIndex++,s;case"JumpToBlock":this.nextBlockIndex+=s.offset;break;case"LoopStart":this.loopToBlockIndex=this.nextBlockIndex+1,this.repeatCount=s.repeatCount,this.nextBlockIndex++;break;case"LoopEnd":this.repeatCount--,this.repeatCount>0?this.nextBlockIndex=this.loopToBlockIndex:this.nextBlockIndex++;break;case"CallSequence":this.callStack.unshift(this.nextBlockIndex+1);for(var n=s.offsets.length-1;n>=0;n--)this.callStack.unshift(this.nextBlockIndex+s.offsets[n]);this.nextBlockIndex=this.callStack.shift();break;case"ReturnFromSequence":this.nextBlockIndex=this.callStack.shift();break;default:this.nextBlockIndex++}}}getNextLoadableBlock(){for(;;){var e=this.getNextMeaningfulBlock(!0);if(!e)return null;if("StandardSpeedData"==e.type||"TurboSpeedData"==e.type)return e.data}}}let o=null,c=null,l=null,h=null,u=null,d=null,p=null,g=null,k=!1,f=null,b=!1,m=null;const y=(e,t,s)=>{u.set(s,o.MACHINE_MEMORY+4096*e+t)},w=()=>{if(!f)return;const e=f.getNextLoadableBlock();if(!e)return;const t=p[4],s=t>>8,n=1&t;let a=p[8];const r=p[2],i=e[0];let c=!0;if(s!=i)c=!1;else if(n){let t=1,s=0,n=i;for(;s<r;){if(t>=e.length){c=!1;break}const r=e[t++];s++,o.poke(a,r),a=a+1&65535,n^=r}c&=t<e.length,c&&(c=n===e[t])}else c=!0;c?p[0]|=1:p[0]&=65534,o.setPC(1506)};onmessage=e=>{switch(e.data.message){case"loadCore":(e=>{const t=(e,t)=>{postMessage({message:"sendToProxy",method:e,args:t})},s={env:{abort:e=>{},debug_print:(e,t)=>{console.log(String.fromCharCode.apply(String,new Uint8Array(l.buffer,e,t)))},nic_socket:(e,s)=>{t("socket",[e,s])},nic_bind:(e,s)=>{t("bind",[e,s])},nic_socket_close:(e,s)=>{t("socket_close",[e])},nic_sendto:(e,s,n,a,r,i)=>{t("sendto",[e,Array.from(new Uint8Array(l.buffer,s,n)),a,Array.from(new Uint8Array(l.buffer,r,i))])},nic_send:(e,s,n)=>{t("send",[e,Array.from(new Uint8Array(l.buffer,s,n))])},nic_connect:(e,s,n,a)=>{t("connect",[e,Array.from(new Uint8Array(l.buffer,s,n)),a])}}};WebAssembly.instantiateStreaming(fetch(new URL("jsspeccy-spectranet.wasm",e),{}),s).then((t=>{c=t.instance.exports,l=c.memory;const s=c.recv_buffer;m=(e,t)=>{switch(e){case"recv":{const e=t[0],n=t[1];new Int8Array(l.buffer,s,n.buffer.length).set(n.buffer),c.compat_rx_data(e,n.buffer.length);break}case"connected":{const e=t[0],s=t[1];c.compat_connected(e,s);break}}};const n={env:{abort:e=>{},spectranetReset:()=>c.nic_w5100_reset(),spectranetRead:e=>c.nic_w5100_read(e),spectranetWrite:(e,t)=>c.nic_w5100_write(e,t),updateSpectranetIO:()=>c.nic_w5100_io()}};WebAssembly.instantiateStreaming(fetch(new URL("jsspeccy-core.wasm",e),{}),n).then((e=>{o=e.instance.exports,h=o.memory,u=new Uint8Array(h.buffer),d=u.subarray(o.FRAME_BUFFER,26112),p=new Uint16Array(o.memory.buffer,o.REGISTERS,12),g=new Uint16Array(o.memory.buffer,o.TAPE_PULSES,o.TAPE_PULSES_LENGTH),o.resetROM(),postMessage({message:"ready"})}))}))})(e.data.baseUrl);break;case"runFrame":if(k)return;const t=e.data.frameBuffer,s=new Uint8Array(t);let n=null,a=null,U=0;if("audioBufferLeft"in e.data?(n=e.data.audioBufferLeft,a=e.data.audioBufferRight,U=n.byteLength/4,o.setAudioSamplesPerFrame(U)):o.setAudioSamplesPerFrame(0),f&&b){const e=o.getTapePulseBufferTstateCount(),t=o.getTapePulseWriteIndex(),[s,n,a]=f.pulseGenerator.emitPulses(g,t,8e4-e);o.setTapePulseBufferState(s,e+n),a&&(b=!1,postMessage({message:"stoppedTape"}))}let x=o.runFrame();for(;x;){switch(x){case 1:throw k=!0,"Unrecognised opcode!";case 2:w();break;default:throw k=!0,"runFrame returned unexpected result: "+x}x=o.resumeFrame()}if(s.set(d),U){const e=new Float32Array(o.memory.buffer,o.AUDIO_BUFFER_LEFT,U),s=new Float32Array(o.memory.buffer,o.AUDIO_BUFFER_RIGHT,U),r=new Float32Array(n),i=new Float32Array(a);r.set(e),i.set(s),postMessage({message:"frameCompleted",frameBuffer:t,audioBufferLeft:n,audioBufferRight:a},[t,n,a])}else postMessage({message:"frameCompleted",frameBuffer:t},[t]);break;case"keyDown":o.keyDown(e.data.row,e.data.mask);break;case"keyUp":o.keyUp(e.data.row,e.data.mask);break;case"setMachineType":o.setMachineType(e.data.type);break;case"reset":o.reset();break;case"nmi":o.nonMaskableInterrupt();break;case"dump":o.dump();break;case"loadMemory":y(e.data.page,e.data.offset,e.data.data);break;case"loadSnapshot":(e=>{o.setMachineType(e.model);for(let t in e.memoryPages)y(t,0,e.memoryPages[t]);["AF","BC","DE","HL","AF_","BC_","DE_","HL_","IX","IY","SP","IR"].forEach(((t,s)=>{p[s]=e.registers[t]})),o.setPC(e.registers.PC),o.setIFF1(e.registers.iff1),o.setIFF2(e.registers.iff2),o.setIM(e.registers.im),o.setHalted(!!e.halted),o.writePort(254,e.ulaState.borderColour),48!=e.model&&o.writePort(32765,e.ulaState.pagingFlags),o.setTStates(e.tstates)})(e.data.snapshot),postMessage({message:"fileOpened",id:e.data.id,mediaType:"snapshot"});break;case"openTAPFile":f=new r(e.data.data),b=!1,postMessage({message:"fileOpened",id:e.data.id,mediaType:"tape"});break;case"openTZXFile":f=new i(e.data.data),b=!1,postMessage({message:"fileOpened",id:e.data.id,mediaType:"tape"});break;case"playTape":f&&!b&&(b=!0,postMessage({message:"playingTape"}));break;case"stopTape":f&&b&&(b=!1,postMessage({message:"stoppedTape"}));break;case"setTapeTraps":o.setTapeTraps(e.data.value);break;case"msg":const S=e.data.method,B=e.data.args;m(S,B);break;case"proxyTerm":c.compat_proxy_term();break;default:console.log("message received by worker:",e.data)}}})();
//# sourceMappingURL=jsspeccy-worker.js.map